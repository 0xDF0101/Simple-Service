<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 1189 | Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        :root {
            --color-level-0: #ebedf0;
            --color-level-1: #9be9a8;
            --color-level-2: #40c463;
            --color-level-3: #30a14e;
            --color-level-4: #216e39;
            --primary-green: #2ea44f;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8f9fa;
            color: #24292f;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 0 rgba(27,31,35,0.04);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: var(--primary-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .welcome-text h2 { margin: 0; font-size: 1.8rem; }
        .welcome-text p { margin: 5px 0 0; color: #57606a; }

        /* --- ì”ë”” ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ --- */
        .contribution-card {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .grass-wrapper {
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .grass-graph {
            display: grid;
            /* ğŸ’¡ grid-template-flow ëŒ€ì‹  ì•„ë˜ ë‘ ì¤„ì„ ì‚¬ìš©í•´! */
            grid-auto-flow: column;     /* ì—´(Column) ë°©í–¥ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì±„ì›€ */
            grid-template-rows: repeat(7, 12px); /* 7í–‰(ìš”ì¼) ê³ ì • */

            grid-auto-columns: 12px;
            gap: 3px;
        }

        .day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background-color: var(--color-level-0);
            position: relative;
        }

        /* íˆ´íŒ íš¨ê³¼ */
        .day:hover::after {
            content: attr(data-info);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #24292f;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
        }

        .level-1 { background-color: var(--color-level-1); }
        .level-2 { background-color: var(--color-level-2); }
        .level-3 { background-color: var(--color-level-3); }
        .level-4 { background-color: var(--color-level-4); }

        .legend {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #57606a;
            margin-top: 10px;
        }

        .legend-box { width: 10px; height: 10px; border-radius: 2px; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="#" class="logo">Step 1189 ğŸŒ¿</a>
    <div class="nav-links">
        <a href="/bibles" style="text-decoration:none; color: #57606a; font-weight:600;">ì„±ê²½ ì½ê¸°í‘œ</a>
    </div>
</nav>

<div class="container">
    <div class="profile-header">
        <div class="avatar">U</div>
        <div class="welcome-text">
            <h2>ì•ˆë…•í•˜ì„¸ìš”, ìœ ì§„ë‹˜!</h2>
            <p>ì˜¤ëŠ˜ë„ ë§ì”€ê³¼ í•¨ê»˜ í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°€ì„¸ìš”.</p>
        </div>
    </div>

    <div class="contribution-card">
        <div class="card-title">1,189ì¥ì„ í–¥í•œ ê¸°ë¡ (ìµœê·¼ 1ë…„)</div>
        <div class="grass-wrapper">
            <div id="grassGraph" class="grass-graph">
            </div>
        </div>
        <div class="legend">
            <span>Less</span>
            <div class="legend-box" style="background: var(--color-level-0);"></div>
            <div class="legend-box level-1"></div>
            <div class="legend-box level-2"></div>
            <div class="legend-box level-3"></div>
            <div class="legend-box level-4"></div>
            <span>More</span>
        </div>
    </div>
</div>

<script>
    async function initMain() {
        try {
            // 1. ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (/main ê²½ë¡œë¡œ JSON ìš”ì²­)
            const response = await fetch('/api/main', {
                headers: { 'Accept': 'application/json' }
            });
            const grassData = await response.json(); // Map<LocalDate, Integer>

            renderGrass(grassData);
        } catch (error) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            // í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ë°ì´í„° (ì„œë²„ ì—°ê²° ì „ í™•ì¸ìš©)
            renderGrass({});
        }
    }

    function renderGrass(data) {
        const graph = document.getElementById('grassGraph');
        graph.innerHTML = '';

        const today = new Date();
        const startDate = new Date();
        startDate.setFullYear(today.getFullYear() - 1);

        // ê¹ƒí—ˆë¸Œì²˜ëŸ¼ ì¼ìš”ì¼ë¶€í„° ì‹œì‘í•˜ë„ë¡ ì •ë ¬ (0: ì¼, 1: ì›”...)
        const startDay = startDate.getDay();
        startDate.setDate(startDate.getDate() - startDay);

        // ì˜¤ëŠ˜ê¹Œì§€ ë‚ ì§œ ë£¨í”„ ëŒë©´ì„œ ì¹¸ ìƒì„±
        let currentDate = new Date(startDate);
        while (currentDate <= today) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const count = data[dateStr] || 0;

            const dayEl = document.createElement('div');
            dayEl.className = 'day ' + getLevelClass(count);
            dayEl.setAttribute('data-info', `${dateStr}: ${count}ì¥ ì½ìŒ`);

            graph.appendChild(dayEl);
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    function getLevelClass(count) {
        if (count === 0) return '';
        if (count <= 1) return 'level-1';
        if (count <= 5) return 'level-2';
        if (count <= 9) return 'level-3';
        return 'level-4';
    }

    initMain();
</script>

</body>
</html>